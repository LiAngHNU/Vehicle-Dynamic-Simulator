%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Published by: Li.Ang
% Email: li.ang@cidi.ai
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
close all; clear; clc;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% System Settings %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Tp = 10;
dS =  5;
Kappa = 0.05;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Vehicle Parameters %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
syms Ms Iz Lf Lr Cf Cr Re;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% System Dynamics %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
syms x1 x2 x3 x4 x5 x6;     % States
syms u1 u2;                 % Inputs
syms v1;                    % Disturbances

t = (1 - x2*v1)/(x4*cos(x3) - x5*sin(x3));

Af = (x5 + Lf*x6)/x3 - u2;
Ar = (x5 - Lr*x6)/x3;

ft1 = (x4*cos(x3) - x5*sin(x3))/(1 - x2*v1);
ft2 = x4*sin(x3) + x5*cos(x3);
ft3 = x6 - x4*v1;
ft4 = (1/Ms)*(u1/Re - Cf*Af*sin(u2) + Ms*x5*x6);
ft5 = (1/Ms)*(Cf*Af*cos(u2)+Cr*Ar - Ms*x4*x6);
ft6 = (1/Iz)*(Cf*Af*Lf*cos(u2) - Cr*Ar*Lr);

fs1 = t*ft2;
fs2 = t*ft3;
fs3 = t*ft4;
fs4 = t*ft5;
fs5 = t*ft6;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% NLP Construction %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
cost = @(x)(1 - Kappa*x(1))*dS/(x(3)*cos(x(2)) - x(4)*sin(x(2))) + r1*x(6)^2 + r2*x(7)^2;
con1 = @(x)