clear;clc;
bag=rosbag('auto_little_ant_2022-8-29-15-46-7-SHANQI_E9_001_0.bag');
control_message_bag=select(bag,'Topic','/control/ControlCmd');
planning_message_bag=select(bag,'Topic','/planning/ADCTrajectory');
control_message=readMessages(control_message_bag,"DataFormat", "struct");
localization_bag = select(bag,'Topic','/localization/localization');
localization_message = readMessages(localization_bag, "DataFormat", "struct");

planning_message=readMessages(planning_message_bag,"DataFormat", "struct");
control_length=length(control_message);
planning_length=length(planning_message);
control_latdebug_name=fieldnames(control_message{1}.Debug.SimpleLatDebug);
control_londebug_name=fieldnames(control_message{1}.Debug.SimpleLonDebug);


for i=1:1:control_length
    control_time(i,1)=(control_message{i,1}.Header.Timestamp-control_message{1,1}.Header.Timestamp)/1000;
    throttle(i,1)=control_message{i,1}.Throttle;
    brake(i,1)=control_message{i,1}.Brake;
    steering(i,1)=control_message{i,1}.Steering;
    targetAcc(i,1)=control_message{i,1}.TargetAcceleration;
  targetSpd(i,1)=control_message{i,1}.TargetSpeed;
    GearCmd(i,1)=control_message{i,1}.GearCmd;
    LateralError(i,1)=control_message{i,1}.Debug.SimpleLatDebug.LateralError;
    RefHeading(i,1)=control_message{i,1}.Debug.SimpleLatDebug.RefHeading;
    Heading(i,1)=control_message{i,1}.Debug.SimpleLatDebug.Heading;
    HeadingError(i,1)=control_message{i,1}.Debug.SimpleLatDebug.HeadingError;
    HeadingErrorRate(i,1)=control_message{i,1}.Debug.SimpleLatDebug.HeadingErrorRate;
    Curvature(i,1)=control_message{i,1}.Debug.SimpleLatDebug.Curvature;
    SteerAngle(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngle;
    SteerAngleFeedforward(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleFeedforward;
   SteerAngleLateralContribution(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleLateralContribution;
    SteerAngleLateralRateContribution(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleLateralRateContribution;
    SteerAngleHeadingContribution(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleHeadingContribution;
    SteerAngleHeadingRateContribution(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleHeadingRateContribution;
    SteerAngleFeedback(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleFeedback;
    SteeringPosition(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteeringPosition;
   RefSpeed(i,1)=control_message{i,1}.Debug.SimpleLatDebug.RefSpeed;
    SteerAngleLimited(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleLimited;
    SteerAngleIntegral(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleIntegral;
    SteerAngleCorrect(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleCorrect;
    SteerAngleRollCompensate(i,1)=control_message{i,1}.Debug.SimpleLatDebug.SteerAngleRollCompensate;
   RefX(i,1)=control_message{i,1}.Debug.SimpleLatDebug.RefX;
    RefY(i,1)=control_message{i,1}.Debug.SimpleLatDebug.RefY;
   RealSpeed(i,1)=control_message{i,1}.Debug.SimpleLatDebug.RealSpeed;
    K1(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatrixK1;
    K2(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatrixK2;
    K3(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatrixK3;
   K4(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatrixK4;
    MatchedLatAcceleration(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatchedLatAcceleration;
    MatchedLatSpeed(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatchedLatSpeed;
   MatchedLatStation(i,1)=control_message{i,1}.Debug.SimpleLatDebug.MatchedLatStation;
    StationReference(i,1)=control_message{i,1}.Debug.SimpleLonDebug.StationReference;
    StationError(i,1)=control_message{i,1}.Debug.SimpleLonDebug.StationError;
    StationErrorLimited(i,1)=control_message{i,1}.Debug.SimpleLonDebug.StationErrorLimited;
    PreviewStationError(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PreviewStationError;
    SpeedReference(i,1)=control_message{i,1}.Debug.SimpleLonDebug.SpeedReference;
    SpeedError(i,1)=control_message{i,1}.Debug.SimpleLonDebug.SpeedError;
    SpeedControllerInputLimited(i,1)=control_message{i,1}.Debug.SimpleLonDebug.SpeedControllerInputLimited;
    PreviewSpeedReference(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PreviewSpeedReference;
    PreviewSpeedError(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PreviewSpeedError;
    PreviewAccelerationReference(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PreviewAccelerationReference;
    AccelerationCmdCloseloop(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AccelerationCmdCloseloop;
    AccelerationCmd(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AccelerationCmd;
    AccelerationLookup(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AccelerationLookup;
    SpeedLookup(i,1)=control_message{i,1}.Debug.SimpleLonDebug.SpeedLookup;
    CalibrationValue(i,1)=control_message{i,1}.Debug.SimpleLonDebug.CalibrationValue;
    ThrottleCmd(i,1)=control_message{i,1}.Debug.SimpleLonDebug.ThrottleCmd;
    BrakeCmd(i,1)=control_message{i,1}.Debug.SimpleLonDebug.BrakeCmd;
    IsFullStop(i,1)=control_message{i,1}.Debug.SimpleLonDebug.IsFullStop;
    SlopeOffsetCompensation(i,1)=control_message{i,1}.Debug.SimpleLonDebug.SlopeOffsetCompensation;
    CurrentStation(i,1)=control_message{i,1}.Debug.SimpleLonDebug.CurrentStation;
    PathRemain(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PathRemain;
    AutoModelTime(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AutoModelTime;
    GearPosition(i,1)=control_message{i,1}.Debug.SimpleLonDebug.GearPosition;
    IsCommonStop(i,1)=control_message{i,1}.Debug.SimpleLonDebug.IsCommonStop;
    CurrentAcc(i,1)=control_message{i,1}.Debug.SimpleLonDebug.CurrentAcc;
    FilteredAcc(i,1)=control_message{i,1}.Debug.SimpleLonDebug.FilteredAcc;
    LonControllerStatus(i,1)=control_message{i,1}.Debug.SimpleLonDebug.LonControllerStatus;
    CommonStopTime(i,1)=control_message{i,1}.Debug.SimpleLonDebug.CommonStopTime;
    CommonStopS(i,1)=control_message{i,1}.Debug.SimpleLonDebug.CommonStopS;
    MatchedLonCurvature(i,1)=control_message{i,1}.Debug.SimpleLonDebug.MatchedLonCurvature;
    MatchedLonStation(i,1)=control_message{i,1}.Debug.SimpleLonDebug.MatchedLonStation;
    PreviewLonStation(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PreviewLonStation;
    PreviewLonCurvature(i,1)=control_message{i,1}.Debug.SimpleLonDebug.PreviewLonCurvature;
    ReferenceLonCurvature(i,1)=control_message{i,1}.Debug.SimpleLonDebug.ReferenceLonCurvature;
    AccelerationCmdFeedforward(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AccelerationCmdFeedforward;
    AccelerationCmdCompensation(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AccelerationCmdCompensation;
    AccelerationCmdCorrection(i,1)=control_message{i,1}.Debug.SimpleLonDebug.AccelerationCmdCorrection;
end
clear i;
for i = 1:length(localization_message)
    Position_x(i,1) = localization_message{i,1}.Position(1);
    Position_y(i,1) = localization_message{i,1}.Position(2);
    Position_yaw(i,1) = localization_message{i,1}.Heading;
end
timeValues = control_time;
LateralError = timetable(milliseconds(timeValues(:)),LateralError,'VariableNames',{'value'});
ref_y=timetable(milliseconds(timeValues(:)),RefY,'VariableNames',{'value'});
HeadingError = timetable(milliseconds(timeValues(:)),HeadingError,'VariableNames',{'value'});
RefHeading = timetable(milliseconds(timeValues(:)),RefHeading,'VariableNames',{'value'});
Heading= timetable(milliseconds(timeValues(:)),Heading,'VariableNames',{'value'});
Curvature=timetable(milliseconds(timeValues(:)),Curvature,'VariableNames',{'value'});
SteerAngle=timetable(milliseconds(timeValues(:)),SteerAngle,'VariableNames',{'value'});
SteerAngleFeedforward=timetable(milliseconds(timeValues(:)),SteerAngleFeedforward,'VariableNames',{'value'});
SteerAngleLateralContribution=timetable(milliseconds(timeValues(:)),SteerAngleLateralContribution,'VariableNames',{'value'});
SteerAngleLateralRateContribution=timetable(milliseconds(timeValues(:)),SteerAngleLateralRateContribution,'VariableNames',{'value'});
SteerAngleHeadingContribution=timetable(milliseconds(timeValues(:)),SteerAngleHeadingContribution,'VariableNames',{'value'});
SteerAngleHeadingRateContribution=timetable(milliseconds(timeValues(:)),SteerAngleHeadingRateContribution,'VariableNames',{'value'});
SteerAngleFeedback=timetable(milliseconds(timeValues(:)),SteerAngleFeedback,'VariableNames',{'value'});
SteeringPosition=timetable(milliseconds(timeValues(:)),SteeringPosition,'VariableNames',{'value'});
RefSpeed=timetable(milliseconds(timeValues(:)),RefSpeed,'VariableNames',{'value'});
SteerAngleLimited=timetable(milliseconds(timeValues(:)),SteerAngleLimited,'VariableNames',{'value'});
SteerAngleIntegral=timetable(milliseconds(timeValues(:)),SteerAngleIntegral,'VariableNames',{'value'});
SteerAngleCorrect=timetable(milliseconds(timeValues(:)),SteerAngleCorrect,'VariableNames',{'value'});
SteerAngleRollCompensate=timetable(milliseconds(timeValues(:)),SteerAngleRollCompensate,'VariableNames',{'value'});
RefX=timetable(milliseconds(timeValues(:)),RefX,'VariableNames',{'value'});
RefY=timetable(milliseconds(timeValues(:)),RefY,'VariableNames',{'value'});
RealSpeed=timetable(milliseconds(timeValues(:)),RealSpeed,'VariableNames',{'value'});
K1=timetable(milliseconds(timeValues(:)),K1,'VariableNames',{'value'});
K2=timetable(milliseconds(timeValues(:)),K2,'VariableNames',{'value'});
K3=timetable(milliseconds(timeValues(:)),K3,'VariableNames',{'value'});
K4=timetable(milliseconds(timeValues(:)),K4,'VariableNames',{'value'});
MatchedLatAcceleration=timetable(milliseconds(timeValues(:)),MatchedLatAcceleration,'VariableNames',{'value'});
MatchedLatSpeed=timetable(milliseconds(timeValues(:)),MatchedLatSpeed,'VariableNames',{'value'});
MatchedLatStation=timetable(milliseconds(timeValues(:)),MatchedLatStation,'VariableNames',{'value'});
StationReference=timetable(milliseconds(timeValues(:)),StationReference,'VariableNames',{'value'});
StationError=timetable(milliseconds(timeValues(:)),StationError,'VariableNames',{'value'});
StationErrorLimited=timetable(milliseconds(timeValues(:)),StationErrorLimited,'VariableNames',{'value'});
PreviewStationError=timetable(milliseconds(timeValues(:)),PreviewStationError,'VariableNames',{'value'});
SpeedReference=timetable(milliseconds(timeValues(:)),SpeedReference,'VariableNames',{'value'});
SpeedError=timetable(milliseconds(timeValues(:)),SpeedError,'VariableNames',{'value'});
SpeedControllerInputLimited=timetable(milliseconds(timeValues(:)),SpeedControllerInputLimited,'VariableNames',{'value'});
PreviewSpeedReference=timetable(milliseconds(timeValues(:)),PreviewSpeedReference,'VariableNames',{'value'});
PreviewSpeedError=timetable(milliseconds(timeValues(:)),PreviewSpeedError,'VariableNames',{'value'});
PreviewAccelerationReference=timetable(milliseconds(timeValues(:)),PreviewAccelerationReference,'VariableNames',{'value'});
AccelerationCmdCloseloop=timetable(milliseconds(timeValues(:)),AccelerationCmdCloseloop,'VariableNames',{'value'});
AccelerationCmd=timetable(milliseconds(timeValues(:)),AccelerationCmd,'VariableNames',{'value'});
AccelerationLookup=timetable(milliseconds(timeValues(:)),AccelerationLookup,'VariableNames',{'value'});
SpeedLookup=timetable(milliseconds(timeValues(:)),SpeedLookup,'VariableNames',{'value'});
CalibrationValue=timetable(milliseconds(timeValues(:)),CalibrationValue,'VariableNames',{'value'});
ThrottleCmd=timetable(milliseconds(timeValues(:)),ThrottleCmd,'VariableNames',{'value'});
BrakeCmd=timetable(milliseconds(timeValues(:)),BrakeCmd,'VariableNames',{'value'});
IsFullStop=timetable(milliseconds(timeValues(:)),IsFullStop,'VariableNames',{'value'});
SlopeOffsetCompensation=timetable(milliseconds(timeValues(:)),SlopeOffsetCompensation,'VariableNames',{'value'});
CurrentStation=timetable(milliseconds(timeValues(:)),CurrentStation,'VariableNames',{'value'});
PathRemain=timetable(milliseconds(timeValues(:)),PathRemain,'VariableNames',{'value'});
AutoModelTime=timetable(milliseconds(timeValues(:)),AutoModelTime,'VariableNames',{'value'});
GearPosition=timetable(milliseconds(timeValues(:)),GearPosition,'VariableNames',{'value'});
IsCommonStop=timetable(milliseconds(timeValues(:)),IsCommonStop,'VariableNames',{'value'});
CurrentAcc=timetable(milliseconds(timeValues(:)),CurrentAcc,'VariableNames',{'value'});
FilteredAcc=timetable(milliseconds(timeValues(:)),FilteredAcc,'VariableNames',{'value'});
LonControllerStatus=timetable(milliseconds(timeValues(:)),LonControllerStatus,'VariableNames',{'value'});
CommonStopTime=timetable(milliseconds(timeValues(:)),CommonStopTime,'VariableNames',{'value'});
CommonStopS=timetable(milliseconds(timeValues(:)),CommonStopS,'VariableNames',{'value'});
MatchedLonCurvature=timetable(milliseconds(timeValues(:)),MatchedLonCurvature,'VariableNames',{'value'});
MatchedLonStation=timetable(milliseconds(timeValues(:)),MatchedLonStation,'VariableNames',{'value'});
PreviewLonStation=timetable(milliseconds(timeValues(:)),PreviewLonStation,'VariableNames',{'value'});
PreviewLonCurvature=timetable(milliseconds(timeValues(:)),PreviewLonCurvature,'VariableNames',{'value'});
ReferenceLonCurvature=timetable(milliseconds(timeValues(:)),ReferenceLonCurvature,'VariableNames',{'value'});
AccelerationCmdFeedforward=timetable(milliseconds(timeValues(:)),AccelerationCmdFeedforward,'VariableNames',{'value'});
AccelerationCmdCompensation=timetable(milliseconds(timeValues(:)),AccelerationCmdCompensation,'VariableNames',{'value'});
AccelerationCmdCorrection=timetable(milliseconds(timeValues(:)),AccelerationCmdCorrection,'VariableNames',{'value'});
throttle= timetable(milliseconds(timeValues(:)),throttle,'VariableNames',{'value'});
brake= timetable(milliseconds(timeValues(:)),brake,'VariableNames',{'value'});
steering= timetable(milliseconds(timeValues(:)),steering,'VariableNames',{'value'});
targetAcc= timetable(milliseconds(timeValues(:)),targetAcc,'VariableNames',{'value'});
targetSpd= timetable(milliseconds(timeValues(:)),targetSpd,'VariableNames',{'value'});
GearCmd= timetable(milliseconds(timeValues(:)),GearCmd,'VariableNames',{'value'});
